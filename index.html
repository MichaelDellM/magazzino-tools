<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Codifica Articoli - Modulo</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e7eef7; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    h1 { margin: 0 0 6px; font-size: 26px; }
    p  { margin: 0 0 16px; color:#b9c7d8; }
    .card { background:#121826; border:1px solid #1f2a3a; border-radius: 14px; padding: 16px; margin: 14px 0; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 820px){ .row { grid-template-columns: 1fr; } }
    label { display:block; font-size: 12px; color:#a9bdd6; margin: 8px 0 6px; }
    input, select, textarea {
      width:100%; box-sizing:border-box;
      background:#0e1420; color:#e7eef7;
      border:1px solid #223047; border-radius: 10px;
      padding: 10px 11px; outline:none;
    }
    textarea { min-height: 70px; resize: vertical; }
    input:focus, select:focus, textarea:focus { border-color:#3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.25); }
    .btnbar { display:flex; flex-wrap:wrap; gap:10px; margin-top: 14px; }
    button, a.btn {
      border:1px solid #2a3a54; background:#172235; color:#e7eef7;
      padding: 10px 12px; border-radius: 12px;
      cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    button.primary, a.btn.primary { background:#1d4ed8; border-color:#1d4ed8; }
    button.danger { background:#3a1a1a; border-color:#5a2222; }
    button:hover, a.btn:hover { filter: brightness(1.08); }
    .muted { color:#9fb3c8; font-size: 12px; }
    .hr { height:1px; background:#1f2a3a; margin: 14px 0; }
    .titleline { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .pill { font-size: 12px; padding: 6px 10px; border-radius: 999px; border:1px solid #2a3a54; background:#0e1420; color:#b9c7d8; }
    pre {
      white-space: pre-wrap; word-break: break-word;
      background:#0e1420; border:1px solid #223047; border-radius: 12px;
      padding: 12px; margin: 0;
    }
    .ok { color:#7ee787; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="titleline">
        <div>
          <h1>Codifica Articoli ‚Äî Modulo</h1>
          <p>Compila i dati (nessun campo √® obbligatorio). Puoi aggiungere pi√π articoli. Alla fine copi il testo o lo invii via email.</p>
        </div>
        <div class="pill">Lingua: Italiano</div>
      </div>
      

      <div class="field">
      <label for="richiedente">Richiedente (Nome e Cognome)</label>
      <input id="richiedente" name="richiedente" type="text" placeholder="Es. Mario Rossi">
      </div>

<div class="btnbar" style="margin-top:10px;">
  <button id="btnShowHome" class="primary" type="button">üè† Home</button>
  <button id="btnShowCodifica" type="button">üßæ Codifica articoli</button>
  <button id="btnShowAcquisto" type="button">üõí Richiesta acquisto</button>
  <button id="btnShowSpedizione" type="button">üì¶ Spedizione</button>
</div>

<div class="hr"></div>

<!-- ===== HOME ===== -->
      
<div id="modHome">
  <div class="card">
    <h2 style="margin:0 0 10px; font-size:18px;">Seleziona modulo</h2>
    <p class="muted" style="margin-top:0;">Scegli cosa vuoi fare.</p>
    
  </div>
</div>

<!-------- FINE HOME -------->


      

      
<!-- ===== MODULO: RICHIESTA ACQUISTO ===== -->
      
<div id="modAcquisto" style="display:none;">
  <div class="card">
    <h2 style="margin:0 0 10px; font-size:18px;">Richiesta acquisto ‚Äî Modulo</h2>

    <div id="acq_items"></div>

    <div class="btnbar">
      <button id="acq_addBtn" class="primary" type="button">‚ûï Aggiungi un altro articolo</button>
      <button id="acq_buildBtn" type="button">‚úÖ Passo 1 ‚Äî Genera riepilogo</button>
      <button id="acq_copyBtn" type="button">üìã Passo 2 ‚Äî Copia il testo</button>
      <a id="acq_mailBtn" class="btn primary" href="#" role="button">‚úâÔ∏è Passo 3 ‚Äî Finalizza e invia</a>
      <button id="acq_clearBtn" class="danger" type="button">üîÑ Ripristina modulo</button>
    </div>

    <p class="muted">
      Destinatari: Fabio (TO) + Michael (CC). L‚Äôinvio usa l‚Äôapp di posta predefinita (mailto).
    </p>
  </div>

  <div class="card">
    <div class="titleline">
      <h2 style="margin:0; font-size:18px;">Riepilogo (Acquisto)</h2>
      <div id="acq_status" class="muted"></div>
    </div>
    <div class="hr"></div>
    <pre id="acq_output">Premi ‚ÄúGenera riepilogo‚Äù.</pre>
  </div>
</div>

<!-------- FINE MODULO: RICHIESTA ACQUISTO -------->




      
<!-- ===== MODULO: RICHIESTA CODIFICA ===== -->

<div id="modCodifica" style="display:none;">
  <div id="items"></div>

  <div class="btnbar">
    <button id="addBtn" class="primary" type="button">‚ûï Aggiungi un altro articolo</button>
    <button id="buildBtn" type="button">‚úÖ Passo 1 ‚Äî Genera riepilogo</button>
    <button id="copyBtn" type="button">üìã Passo 2 ‚Äî Copia il testo</button>
    <a id="mailBtn" class="btn primary" href="#" role="button">‚úâÔ∏è Passo 3 ‚Äî Finalizza e invia</a>
    <button id="clearBtn" class="danger" type="button">üîÑ Ripristina modulo</button>
  </div>

  <div class="card">
    <div class="titleline">
      <h2 style="margin:0; font-size:18px;">Riepilogo (Codifica)</h2>
      <div id="status" class="muted"></div>
    </div>
    <div class="hr"></div>
    <pre id="output">Premi ‚ÄúGenera riepilogo‚Äù.</pre>
  </div>

  <p class="muted">
    Nota: ‚ÄúInvia via email‚Äù usa l‚Äôapp di posta predefinita del dispositivo (mailto). Se non si apre, copia il riepilogo e incollalo manualmente in Outlook.
  </p>
</div>

<!-------- FINE MODULO: RICHIESTA CODIFICA -------->




      
<!-- ===== MODULO: RICHIESTA SPEDIZIONE ===== -->
<div id="modSpedizione" style="display:none;">
  <div class="card">
    <h2 style="margin:0 0 10px; font-size:18px;">Spedizione ‚Äî Modulo</h2>

    <div class="row">
      <div>
        <label>Trasporto a cura di</label>
        <div style="display:flex; gap:18px; padding:8px 2px; flex-wrap:wrap;">
          <label style="display:flex; gap:8px; align-items:center; margin:0; font-size:14px; color:#e7eef7;">
            <input type="radio" name="spd_trasporto" value="Mittente"> Mittente
          </label>
          <label style="display:flex; gap:8px; align-items:center; margin:0; font-size:14px; color:#e7eef7;">
            <input type="radio" name="spd_trasporto" value="Destinatario" checked> Destinatario
          </label>
          <label style="display:flex; gap:8px; align-items:center; margin:0; font-size:14px; color:#e7eef7;">
            <input type="radio" name="spd_trasporto" value="Vettore"> Vettore
          </label>
        </div>
      </div>

      <div>
        <label>Destinatario</label>
        <input id="spd_destinatario" type="text" placeholder="Ragione sociale + indirizzo (se disponibile)" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>N¬∞ Colli</label>
        <input id="spd_colli" type="text" inputmode="numeric" placeholder="Es. 3" />
      </div>
      <div>
        <label>Peso</label>
        <input id="spd_peso" type="text" placeholder="Es. 12 kg" />
      </div>
    </div>

    <label>Aspetto</label>
    <input id="spd_aspetto" type="text" placeholder="Es. Scatole / Bancale / Imballo..." />

    <div class="hr"></div>

    <div id="spd_items"></div>

    <div class="btnbar">
      <button id="spd_addBtn" class="primary" type="button">‚ûï Aggiungi riga</button>
      <button id="spd_buildBtn" type="button">‚úÖ Passo 1 ‚Äî Genera riepilogo</button>
      <button id="spd_copyBtn" type="button">üìã Passo 2 ‚Äî Copia il testo</button>
      <a id="spd_mailBtn" class="btn primary" href="#" role="button">‚úâÔ∏è Passo 3 ‚Äî Finalizza e invia</a>
      <button id="spd_clearBtn" class="danger" type="button">üîÑ Ripristina modulo</button>
    </div>

    <p class="muted">
      Nota: ‚ÄúInvia via email‚Äù usa l‚Äôapp di posta predefinita (mailto). Se non si apre, copia il riepilogo e incollalo manualmente in Outlook.
    </p>
  </div>

  <div class="card">
    <div class="titleline">
      <h2 style="margin:0; font-size:18px;">Riepilogo (Spedizione)</h2>
      <div id="spd_status" class="muted"></div>
    </div>
    <div class="hr"></div>
    <pre id="spd_output">Premi ‚ÄúGenera riepilogo‚Äù.</pre>
  </div>
</div>
    

<!-------- FINE MODULO: RICHIESTA SPEDIZIONE -------->




  
<script>
  const $ = (id) => document.getElementById(id);


  
  // ===== TEMPLATE CODIFICA ARTICOLO =====
  
  const templateItem = (n) => `
    <div class="card" data-item>
      <div class="titleline">
        <strong>Articolo ${n}</strong>
        <button type="button" class="danger" onclick="removeItem(this)">Rimuovi</button>
      </div>

      <div class="row">
        <div>
          <label>Tipo articolo (M / E / A / I)</label>
          <select data-field="tipo">
            <option value="">(vuoto)</option>
            <option value="M">M</option>
            <option value="E">E</option>
            <option value="A">A</option>
            <option value="I">I</option>
          </select>
        </div>
        <div>
          <label>Fornitore</label>
          <input data-field="fornitore" type="text" placeholder="Es. Rubix" />
        </div>
      </div>

      <label>Nome / Descrizione</label>
      <input data-field="descrizione" type="text" placeholder="Descrizione articolo" />

      <div class="row">
        <div>
          <label>Linea (macchina)</label>
          <input data-field="linea" type="text" placeholder="Es. Linea 2 - Raffinatrice 4" />
        </div>
        <div>
          <label>Costruttore</label>
          <input data-field="costruttore" type="text" placeholder="Es. Festo, Siemens, ..." />
        </div>
      </div>

      <label>Ubicazione</label>
      <input data-field="ubicazione" type="text" placeholder="Es. Mansarda / M2 / M4 ..." />

      <div class="row">
        <div>
          <label>Approvvigionamento (Min)</label>
          <input data-field="min" type="text" inputmode="numeric" placeholder="Minimo" />
        </div>
        <div>
          <label>Approvvigionamento (Max)</label>
          <input data-field="max" type="text" inputmode="numeric" placeholder="Massimo" />
        </div>
      </div>

      <label>Note (opzionale)</label>
      <textarea data-field="note" placeholder="Eventuali note..."></textarea>
    </div>
  `;

// ===== FINE TEMPLATE CODIFICA ARTICOLO =====


  
// === EMAILS FISSI (Acquisto) ===
  
const EMAIL_MICHAEL = "mdellorto@lindt.com";
const EMAIL_FABIO   = "fcastagna@lindt.com";


  
// ===== TEMPLATE ARTICOLO ACQUISTO =====
  
const templateAcqItem = (n) => `
  <div class="card" data-acq-item>
    <div class="titleline">
      <strong>Articolo ${n}</strong>
      <button type="button" class="danger" onclick="removeAcqItem(this)">Rimuovi</button>
    </div>

    <div class="row">
      <div>
        <label>Articolo gi√† codificato?</label>
        <select data-acq="codificato" onchange="toggleAcqCodificato(this)">
          <option value="SI">S√¨</option>
          <option value="NO">No</option>
        </select>
      </div>

      <div>
        <label>Urgenza</label>
        <select data-acq="urgenza">
          <option value="Normale">Normale</option>
          <option value="Alta">Alta</option>
          <option value="Macchina critica, rischio fermo">Macchina critica, rischio fermo</option>
        </select>
      </div>
    </div>

    <div data-acq-section="si">
      <div class="row">
        <div>
          <label>Codice CARL (interno)</label>
          <input data-acq="carl" type="text" placeholder="Es. M12345 / A000..." />
        </div>
        <div>
          <label>Descrizione breve</label>
          <input data-acq="descr_breve" type="text" placeholder="Descrizione breve" />
        </div>
      </div>
    </div>

    <div data-acq-section="no" style="display:none;">
      <label>Descrizione completa (come codifica)</label>
      <textarea data-acq="descr_completa" placeholder="Descrizione completa..."></textarea>
    </div>

    <label>Quantit√†</label>
    <input data-acq="qty" type="text" inputmode="numeric" placeholder="Es. 2" />

    <div class="row">
      <div>
        <label>Unit√†</label>
        <select data-acq="unita" onchange="toggleAcqSet(this)">
          <option value="pz">pz</option>
          <option value="mt">mt</option>
          <option value="kg">kg</option>
          <option value="set">set</option>
        </select>
      </div>
      <div data-acq-set style="display:none;">
        <label>Pezzi per set</label>
        <input data-acq="pezzi_set" type="text" inputmode="numeric" placeholder="Es. 4" />
      </div>
    </div>

    <label>Fornitore (se conosciuto) / a scelta</label>
    <input data-acq="fornitore" type="text" placeholder="Es. Rubix / a scelta" />

    <div class="row">
      <div>
        <label>Costruttore / Marca (opzionale)</label>
        <input data-acq="marca" type="text" placeholder="Es. Siemens, Festo..." />
      </div>
      <div>
        <label>Macchina / Linea d‚Äôuso</label>
        <input data-acq="macchina_linea" type="text" placeholder="Es. Raffinatrice 4 / Linea 2" />
      </div>
    </div>

    <label>Riferimento (cod. fornitore / modello / link / ‚Äúfoto allegata‚Äù)</label>
    <input data-acq="riferimento" type="text" placeholder="Es. DSBC-40-80... / link / foto allegata" />

    <label>Motivo</label>
    <select data-acq="motivo">
      <option value="Scorta">Scorta</option>
      <option value="Rottura">Rottura</option>
      <option value="Miglioramento">Miglioramento</option>
      <option value="Progetto">Progetto</option>
      <option value="Prova">Prova</option>
    </select>

    <label>Note (opzionale)</label>
    <textarea data-acq="note" placeholder="Note sull‚Äôarticolo..."></textarea>
  </div>
`;

// ===== FINE TEMPLATE ARTICOLO ACQUISTO =====



  

// ====== FUNZIONI JS ACQUISTI ======
  
function acqSetStatus(msg, ok=false){
  const el = document.getElementById('acq_status');
  if (!el) return;
  el.textContent = msg;
  el.className = ok ? 'muted ok' : 'muted';
  clearTimeout(window.__acqst);
  window.__acqst = setTimeout(()=>{ el.textContent=''; }, 3500);
}

function acqRenumber(){
  const cards = document.querySelectorAll('[data-acq-item]');
  cards.forEach((card, idx) => {
    const title = card.querySelector('strong');
    if (title) title.textContent = `Articolo ${idx + 1}`;
  });
}

window.removeAcqItem = (btn) => {
  const card = btn.closest('[data-acq-item]');
  if (card) card.remove();
  acqRenumber();
  acqSetStatus('Articolo rimosso.');
};

window.toggleAcqCodificato = (selectEl) => {
  const card = selectEl.closest('[data-acq-item]');
  const yes = card.querySelector('[data-acq-section="si"]');
  const no  = card.querySelector('[data-acq-section="no"]');
  if (selectEl.value === 'SI'){
    yes.style.display = '';
    no.style.display  = 'none';
  } else {
    yes.style.display = 'none';
    no.style.display  = '';
  }
};

window.toggleAcqSet = (selectEl) => {
  const card = selectEl.closest('[data-acq-item]');
  const box = card.querySelector('[data-acq-set]');
  box.style.display = (selectEl.value === 'set') ? '' : 'none';
};

function acqAddItem(){
  const container = document.getElementById('acq_items');
  const n = container.querySelectorAll('[data-acq-item]').length + 1;
  const wrapper = document.createElement('div');
  wrapper.innerHTML = templateAcqItem(n);
  container.appendChild(wrapper.firstElementChild);

  // init toggle states
  const last = container.querySelectorAll('[data-acq-item]')[n-1];
  toggleAcqCodificato(last.querySelector('[data-acq="codificato"]'));
  toggleAcqSet(last.querySelector('[data-acq="unita"]'));

  acqSetStatus('Articolo aggiunto.');
}

function acqGetItems(){
  const cards = document.querySelectorAll('[data-acq-item]');
  return Array.from(cards).map((card, idx) => {
    const get = (name) => (card.querySelector(`[data-acq="${name}"]`)?.value || '').trim();
    return {
      idx: idx + 1,
      codificato: get('codificato'),
      carl: get('carl'),
      descr_breve: get('descr_breve'),
      descr_completa: get('descr_completa'),
      qty: get('qty'),
      unita: get('unita'),
      pezzi_set: get('pezzi_set'),
      fornitore: get('fornitore'),
      marca: get('marca'),
      macchina_linea: get('macchina_linea'),
      riferimento: get('riferimento'),
      motivo: get('motivo'),
      urgenza: get('urgenza'),
      note: get('note'),
    };
  });
}
  
function acqBuildSummary(){
  const rich = (document.getElementById('richiedente')?.value || '').trim();
  const items = acqGetItems();

  const lines = [];
  lines.push('RICHIESTA ACQUISTO');
  lines.push('--------------------------------');
  lines.push(`Richiedente: ${rich || '(non indicato)'}`);
  lines.push(`Numero articoli: ${items.length}`);
  lines.push('');

  items.forEach(it => {
    lines.push(`ARTICOLO ${it.idx}`);
    lines.push(`- Urgenza: ${it.urgenza || '(non indicato)'}`);
    lines.push(`- Articolo gi√† codificato: ${it.codificato || '(non indicato)'}`);

    if (it.codificato === 'SI'){
      if (it.carl) lines.push(`- Codice CARL: ${it.carl}`);
      if (it.descr_breve) lines.push(`- Descrizione breve: ${it.descr_breve}`);
    } else {
      if (it.descr_completa) lines.push(`- Descrizione completa: ${it.descr_completa}`);
    }

    if (it.qty) lines.push(`- Quantit√†: ${it.qty}`);

    if (it.unita){
      let un = it.unita;
      if (un === 'set' && it.pezzi_set) un += ` (pezzi per set: ${it.pezzi_set})`;
      lines.push(`- Unit√†: ${un}`);
    }

    if (it.fornitore) lines.push(`- Fornitore: ${it.fornitore}`);
    if (it.marca) lines.push(`- Costruttore/Marca: ${it.marca}`);
    if (it.macchina_linea) lines.push(`- Macchina/Linea d‚Äôuso: ${it.macchina_linea}`);
    if (it.riferimento) lines.push(`- Riferimento: ${it.riferimento}`);
    if (it.motivo) lines.push(`- Motivo: ${it.motivo}`);
    if (it.note) lines.push(`- Note: ${it.note}`);
    lines.push('');
  });

  lines.push('Grazie.');
  const text = lines.join('\n');

  document.getElementById('acq_output').textContent = text;

  const subject = encodeURIComponent('Richiesta acquisto');
  const body = encodeURIComponent(text);

  const to = encodeURIComponent(EMAIL_FABIO);
  const cc = encodeURIComponent(EMAIL_MICHAEL);

  document.getElementById('acq_mailBtn').href =
    `mailto:${to}?cc=${cc}&subject=${subject}&body=${body}`;

  acqSetStatus('Riepilogo generato. ‚úÖ', true);
  return text;
}

async function acqCopySummary(){
  const text = acqBuildSummary();
  try {
    await navigator.clipboard.writeText(text);
    acqSetStatus('Copiato negli appunti. ‚úÖ', true);
  } catch (e){
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    acqSetStatus('Copiato (fallback). ‚úÖ', true);
  }
}

function acqReset(){
 
  document.getElementById('acq_items').innerHTML = '';
  document.getElementById('acq_output').textContent = 'Premi ‚ÄúGenera riepilogo‚Äù.';
  acqAddItem();
  acqSetStatus('Ripristinato.');
}

  function renumberItems(){
    const cards = document.querySelectorAll('[data-item]');
    cards.forEach((card, idx) => {
      const title = card.querySelector('strong');
      if (title) title.textContent = `Articolo ${idx + 1}`;
    });
  }

  window.removeItem = (btn) => {
    const card = btn.closest('[data-item]');
    if (card) card.remove();
    renumberItems();
    setStatus('Articolo rimosso.');
  };

  function addItem(){
    const container = $('items');
    const n = container.querySelectorAll('[data-item]').length + 1;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = templateItem(n);
    container.appendChild(wrapper.firstElementChild);
    setStatus('Articolo aggiunto.');
  }

  function getItemsData(){
    const cards = document.querySelectorAll('[data-item]');
    return Array.from(cards).map((card, idx) => {
      const get = (name) => (card.querySelector(`[data-field="${name}"]`)?.value || '').trim();
      return {
        idx: idx + 1,
        tipo: get('tipo'),
        descrizione: get('descrizione'),
        linea: get('linea'),
        fornitore: get('fornitore'),
        costruttore: get('costruttore'),
        ubicazione: get('ubicazione'),
        min: get('min'),
        max: get('max'),
        note: get('note'),
      };
    });
  }

  // ------ FINE FUNZIONI JS ACQUISTI ------



  

// ====== FUNZIONI JS SPEDIZIONE ======


const EMAIL_SPED_TO = EMAIL_MICHAEL;  
const EMAIL_SPED_CC = EMAIL_FABIO;     

const templateSpdItem = (n) => `
  <div class="card" data-spd-item>
    <div class="titleline">
      <strong>Riga ${n}</strong>
      <button type="button" class="danger" onclick="removeSpdItem(this)">Rimuovi</button>
    </div>

    <label>Descrizione</label>
    <input data-spd="descrizione" type="text" placeholder="Descrizione materiale / articolo..." />

    <div class="row">
      <div>
        <label>Q.t√†</label>
        <input data-spd="qta" type="text" inputmode="numeric" placeholder="Es. 2" />
      </div>

      <div>
        <label>Cau.</label>
        <select data-spd="cau">
          <option value="">(seleziona)</option>

          <optgroup label="Resi / Riparazioni / Trasferimenti">
            <option value="RGA">RGA ‚Äî Reso in garanzia</option>
            <option value="RSN">RSN ‚Äî Reso non conforme</option>
            <option value="ROM">ROM ‚Äî Reso omaggio</option>
            <option value="RST">RST ‚Äî Restituzione</option>
            <option value="RIE">RIE ‚Äî Rientro in sede</option>
            <option value="RIP">RIP ‚Äî Riparazione</option>
            <option value="SMA">SMA ‚Äî Smaltimento</option>
            <option value="TCD">TCD ‚Äî Trasf c/deposito</option>
            <option value="TRA">TRA ‚Äî Trasf. sede secondaria</option>
            <option value="TRR">TRR ‚Äî Trasferimento</option>
            <option value="INT">INT ‚Äî Trasporto interno</option>
            <option value="VEN">VEN ‚Äî Vendita</option>
            <option value="VEA">VEA ‚Äî Vendita da neg. azien.</option>
            <option value="VIS">VIS ‚Äî Visione</option>
          </optgroup>

          <optgroup label="Prove / Produzione / Macchina">
            <option value="PRD">PRD ‚Äî Prove di dosaggio</option>
            <option value="PDP">PDP ‚Äî Prove di produzione</option>
            <option value="PRM">PRM ‚Äî Prove macchina</option>
          </optgroup>

          <optgroup label="Resi (varianti)">
            <option value="REI">REI ‚Äî Reso</option>
            <option value="RFO">RFO ‚Äî Reso a fornitore</option>
            <option value="RCD">RCD ‚Äî Reso c/deposito</option>
            <option value="RES">RES ‚Äî Reso c/lavorazione</option>
            <option value="RRI">RRI ‚Äî Reso c/riparazione</option>
            <option value="ION">ION ‚Äî Reso c/sostituzione</option>
            <option value="REV">REV ‚Äî Reso c/visione</option>
            <option value="RCO">RCO ‚Äî Reso comodato</option>
            <option value="RCG">RCG ‚Äî Reso comodato gratuito</option>
            <option value="REL">REL ‚Äî Reso da c/locazione</option>
            <option value="RCN">RCN ‚Äî Reso da c/noleggio</option>
            <option value="RPU">RPU ‚Äî Reso da prestito d'uso</option>
            <option value="RSO">RSO ‚Äî Reso da sostituzione definitiva</option>
          </optgroup>

          <optgroup label="Altri">
            <option value="ALL">ALL ‚Äî C/Allestimento</option>
            <option value="CPR">CPR ‚Äî Camp. per prove</option>
            <option value="CAM">CAM ‚Äî Campionario</option>
            <option value="ANA">ANA ‚Äî Campioni per analisi</option>
            <option value="CAR">CAR ‚Äî Carico c/deposito</option>
            <option value="CES">CES ‚Äî Cessione gratuita</option>
            <option value="COM">COM ‚Äî Comodato</option>
            <option value="COG">COG ‚Äî Comodato gratuito</option>
            <option value="DEP">DEP ‚Äî Conto deposito</option>
            <option value="LAV">LAV ‚Äî Conto/lavorazione</option>
            <option value="PRO">PRO ‚Äî Mat. promozionale</option>
            <option value="SOS">SOS ‚Äî Merce in sostituzione</option>
            <option value="MOD">MOD ‚Äî Modifica</option>
            <option value="PRE">PRE ‚Äî Prestito d'uso</option>
            <option value="TES">TES ‚Äî Prodotto per test</option>
            <option value="PRC">PRC ‚Äî Prove di confezione</option>
          </optgroup>
        </select>
      </div>
    </div>
  </div>
`;

function spdSetStatus(msg, ok=false){
  const el = document.getElementById('spd_status');
  if (!el) return;
  el.textContent = msg;
  el.className = ok ? 'muted ok' : 'muted';
  clearTimeout(window.__spdst);
  window.__spdst = setTimeout(()=>{ el.textContent=''; }, 3500);
}

function spdRenumber(){
  document.querySelectorAll('[data-spd-item]').forEach((card, idx) => {
    const title = card.querySelector('strong');
    if (title) title.textContent = `Riga ${idx + 1}`;
  });
}

window.removeSpdItem = (btn) => {
  btn.closest('[data-spd-item]')?.remove();
  spdRenumber();
  spdSetStatus('Riga rimossa.');
};

function spdAddItem(){
  const container = document.getElementById('spd_items');
  const n = container.querySelectorAll('[data-spd-item]').length + 1;
  const wrapper = document.createElement('div');
  wrapper.innerHTML = templateSpdItem(n);
  container.appendChild(wrapper.firstElementChild);
  spdSetStatus('Riga aggiunta.');
}

function spdGetTrasporto(){
  return document.querySelector('input[name="spd_trasporto"]:checked')?.value || '';
}

function spdGetItems(){
  return Array.from(document.querySelectorAll('[data-spd-item]')).map((card, idx) => {
    const get = (name) => (card.querySelector(`[data-spd="${name}"]`)?.value || '').trim();
    return {
      idx: idx + 1,
      descrizione: get('descrizione'),
      qta: get('qta'),
      cau: get('cau'),
      cau_label: card.querySelector(`[data-spd="cau"] option:checked`)?.textContent?.trim() || ''
    };
  });
}

function spdBuildSummary(){
  const rich = (document.getElementById('richiedente')?.value || '').trim();
  const trasporto = spdGetTrasporto();
  const destinatario = (document.getElementById('spd_destinatario')?.value || '').trim();
  const colli = (document.getElementById('spd_colli')?.value || '').trim();
  const peso = (document.getElementById('spd_peso')?.value || '').trim();
  const aspetto = (document.getElementById('spd_aspetto')?.value || '').trim();

  const items = spdGetItems();

  const lines = [];
  lines.push('RICHIESTA SPEDIZIONE (DDT)');
  lines.push('--------------------------------');
  lines.push(`Richiedente: ${rich || '(non indicato)'}`);
  lines.push(`Trasporto a cura di: ${trasporto || '(non indicato)'}`);
  lines.push(`Destinatario: ${destinatario || '(non indicato)'}`);
  if (colli) lines.push(`N¬∞ Colli: ${colli}`);
  if (peso) lines.push(`Peso: ${peso}`);
  if (aspetto) lines.push(`Aspetto: ${aspetto}`);
  lines.push('');
  lines.push(`Numero righe: ${items.length}`);
  lines.push('');

  items.forEach(it => {
    lines.push(`RIGA ${it.idx}`);
    if (it.descrizione) lines.push(`- Descrizione: ${it.descrizione}`);
    if (it.qta) lines.push(`- Q.t√†: ${it.qta}`);
    if (it.cau) lines.push(`- Cau.: ${it.cau_label || it.cau}`);
    lines.push('');
  });

  lines.push('Grazie.');
  const text = lines.join('\n');

  document.getElementById('spd_output').textContent = text;

  const subject = encodeURIComponent('Richiesta spedizione (DDT)');
  const body = encodeURIComponent(text);
  const to = encodeURIComponent(EMAIL_SPED_TO);
  const cc = encodeURIComponent(EMAIL_SPED_CC);

  document.getElementById('spd_mailBtn').href =
    `mailto:${to}?cc=${cc}&subject=${subject}&body=${body}`;

  spdSetStatus('Riepilogo generato. ‚úÖ', true);
  return text;
}

async function spdCopySummary(){
  const text = spdBuildSummary();
  try {
    await navigator.clipboard.writeText(text);
    spdSetStatus('Copiato negli appunti. ‚úÖ', true);
  } catch {
    spdSetStatus('Clipboard bloccato: copia manualmente dal riepilogo.', false);
  }
}

function spdReset(){
  document.getElementById('spd_destinatario').value = '';
  document.getElementById('spd_colli').value = '';
  document.getElementById('spd_peso').value = '';
  document.getElementById('spd_aspetto').value = '';
  document.getElementById('spd_items').innerHTML = '';
  document.getElementById('spd_output').textContent = 'Premi ‚ÄúGenera riepilogo‚Äù.';
  spdAddItem();
  spdSetStatus('Ripristinato.');
}


  

// INIT UNICO

(function initApp() {
  // --- Bind bottoni CODIFICA (safe) ---
  $('addBtn')?.addEventListener('click', addItem);
  $('buildBtn')?.addEventListener('click', codBuildSummary);
  $('copyBtn')?.addEventListener('click', codCopySummary);
  $('clearBtn')?.addEventListener('click', codReset);

  // --- Bind bottoni ACQUISTO (safe) ---
  document.getElementById('acq_addBtn')?.addEventListener('click', acqAddItem);
  document.getElementById('acq_buildBtn')?.addEventListener('click', acqBuildSummary);
  document.getElementById('acq_copyBtn')?.addEventListener('click', acqCopySummary);
  document.getElementById('acq_clearBtn')?.addEventListener('click', acqReset);

    // --- Bind bottoni SPEDIZIONE (safe) ---
  document.getElementById('spd_addBtn')?.addEventListener('click', spdAddItem);
  document.getElementById('spd_buildBtn')?.addEventListener('click', spdBuildSummary);
  document.getElementById('spd_copyBtn')?.addEventListener('click', spdCopySummary);
  document.getElementById('spd_clearBtn')?.addEventListener('click', spdReset);


  // --- Crea 1 articolo per modulo (solo se vuoto) ---
  if (document.querySelectorAll('[data-item]').length === 0) addItem();
  if (document.querySelectorAll('[data-acq-item]').length === 0) acqAddItem();
   if (document.querySelectorAll('[data-spd-item]').length === 0) spdAddItem();

  
  // --- LOGICA MOSTRA/NASCONDI MODULI ---
 function showModule(which){
  const home = document.getElementById('modHome');
  const cod  = document.getElementById('modCodifica');
  const acq  = document.getElementById('modAcquisto');
  const spd  = document.getElementById('modSpedizione');

  const btnHome = document.getElementById('btnShowHome');
  const btnCod  = document.getElementById('btnShowCodifica');
  const btnAcq  = document.getElementById('btnShowAcquisto');
  const btnSpd  = document.getElementById('btnShowSpedizione');

  // seguridad
  if (!home || !cod || !acq || !spd) return;

  // oculta todo
  home.style.display = 'none';
  cod.style.display  = 'none';
  acq.style.display  = 'none';
  spd.style.display  = 'none';

  // muestra el seleccionado
  if (which === 'codifica') cod.style.display = 'block';
  else if (which === 'acquisto') acq.style.display = 'block';
  else if (which === 'spedizione') spd.style.display = 'block';
  else home.style.display = 'block'; // default HOME

  // resalta bot√≥n activo
  const map = { home: btnHome, codifica: btnCod, acquisto: btnAcq, spedizione: btnSpd };
  [btnHome, btnCod, btnAcq, btnSpd].forEach(b => b && b.classList.remove('primary'));
  if (map[which]) map[which].classList.add('primary');
  else btnHome?.classList.add('primary');
}


  // Barra superior (siempre visible)
document.getElementById('btnShowHome')?.addEventListener('click', () => showModule('home'));
document.getElementById('btnShowCodifica')?.addEventListener('click', () => showModule('codifica'));
document.getElementById('btnShowAcquisto')?.addEventListener('click', () => showModule('acquisto'));
document.getElementById('btnShowSpedizione')?.addEventListener('click', () => showModule('spedizione'));

// Botones grandes en HOME
document.getElementById('homeCodifica')?.addEventListener('click', () => showModule('codifica'));
document.getElementById('homeAcquisto')?.addEventListener('click', () => showModule('acquisto'));
document.getElementById('homeSpedizione')?.addEventListener('click', () => showModule('spedizione'));


  showModule('home'); // al inicio: SOLO HOME, ning√∫n formulario

})();
</script>
</body>
</html>
